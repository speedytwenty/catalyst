<?php
/**
 * @file
 * Code for the Catalyst Page feature.
 */

include_once 'catalyst_page.features.inc';

/**
 * Implements hook_theme().
 */
function catalyst_page_theme() {
  return array(
    'cpage_content' => array(
      'variables' => array(
        'template' => NULL,
      ),
    ),
  );
}

/**
 * Implements hook_block_placements().
 */
function catalyst_page_block_placements() {
  $node = menu_get_object();
  if (!empty($node->field__blockplacements__layfield)) {
    return $node->field__blockplacements__layfield[$node->language];
  }
}

function catalyst_page_form_cpage_node_form_alter(&$form, &$form_state) {
  $query = new EntityFieldQuery;
  $query->entityCondition('entity_type', 'catalyst')
    ->entityCondition('bundle', 'layout')
    ->addMetaData('account', user_load(1))
    ->addTag(__FUNCTION__);
  $result = $query->execute();
  if (isset($result['catalyst'])) {
    $callbacks = array(
      'onselect' => array(),
      'ondeselect' => array(),
    );
    $layouts = entity_load('catalyst', array_keys($result['catalyst']));
    foreach ($layouts AS $id => $_layout) {
      $layout = entity_metadata_wrapper('catalyst', $_layout);
      if ($onselect = $layout->field__onselect->value()) {
        $callbacks['onselect'][$id] = $onselect;
      }
      if ($ondeselect = $layout->field__ondeselect->value()) {
        $callbacks['ondeselect'][$id] = $ondeselect;
      }
    }
    $form['#attached']['js']['catalyst_page'] = drupal_get_path('module', 'catalyst_page') . '/catalyst_page_form.js';
    drupal_add_js(array(
      'pageLayoutOnChange' => array(
        'selector' => '#edit-field-cpage-layout-und',
        'callbacks' => $callbacks,
      )),
      'setting'
    );
  }
}

/**
 * Implements hook_node_view().
 */
function catalyst_page_node_view($node, $view_mode, $langcode) {
  $wrapper = entity_metadata_wrapper('node', $node);
  if ($wrapper->getBundle() == 'cpage' && $view_mode == 'full') {
    if ($layout = $wrapper->field__layout->value()) {
      catalyst_set_layout($layout);
    }
  }
}

/**
 * Implements hook_node_view_alter().
 */
function catalyst_page_node_view_alter(&$build) {
  if (isset($build['field__body'])) {
    if ($template = $build['field__body'][0]['#markup']) {
      $build['field__body'][0]['#markup'] = theme('cpage_content', array(
        'template' => new CatalystNodePage($build['#node']),
      ));
    }
  }
}

function template_process_cpage_content(&$variables) {
  $variables['title'] = drupal_get_title();
}

function catalyst_page_preprocess_cpage_content(&$variables) {
  $template = $variables['template'];

  // Custom processing defined by the page
  if ($preprocess_php = $template->getPreprocessPHP()) {
    catalyst_eval($preprocess_php, $variables);
  }
  // Custom HTML head defined by the page
  if ($custom_html_head = $template->getHTMLHead()) {
    drupal_add_html_head(
      array(
        '#type' => 'markup',
        '#markup' => $custom_html_head . "\n",
      ),
      'cpage_html_head'
    );
  }
}

function theme_cpage_content($variables) {
  return $variables['template']->renderTemplate($variables);
}
